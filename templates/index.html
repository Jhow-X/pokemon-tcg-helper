<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pok√©mon TCG Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Tela de Conex√£o -->
    <div id="connection-screen" class="connection-screen">
        <div class="connection-content">
            <h1>üé¥ Pok√©mon TCG Tracker</h1>
            <div class="connection-options">
                <div class="option-group">
                    <h3>Criar Nova Partida</h3>
                    <input type="text" id="player-name-create" placeholder="Seu nome" maxlength="20">
                    <button onclick="createNewGame()" class="create-btn">üéÆ Criar Jogo</button>
                </div>
                
                <div class="option-group">
                    <h3>Entrar em Partida</h3>
                    <input type="text" id="player-name-join" placeholder="Seu nome" maxlength="20">
                    <input type="text" id="room-code" placeholder="C√≥digo da Sala" maxlength="8">
                    <button onclick="joinExistingGame()" class="join-btn">üîó Entrar</button>
                </div>
            </div>
            
            <div id="connection-status" class="connection-status">
                <div class="status-indicator">üî¥ Desconectado</div>
            </div>
        </div>
    </div>

    <!-- Tela do Jogo -->
    <div id="game-screen" class="game-screen" style="display: none;">
        <div class="container">
            <header>
                <h1>üé¥ Pok√©mon TCG Battle Tracker</h1>
                <div class="game-info">
                    <div class="room-info">
                        <span>Sala: <strong id="room-display"></strong></span>
                        <button onclick="copyRoomCode()" class="copy-btn">üìã</button>
                    </div>
                    <div class="player-info">
                        <span id="player-role"></span>
                    </div>
                </div>
                <div class="header-buttons">
                    <button onclick="resetGame()" class="reset-btn">üîÑ Resetar Jogo</button>
                    <button onclick="returnToHome()" class="home-btn">üè† Voltar</button>
                </div>
            </header>

            <div class="game-board">
                <!-- Jogador 2 (Oponente) -->
                <div class="player-section player2">
                    <h2>üë§ <span id="player2-name">Jogador 2</span> <span id="player2-status" class="connection-indicator">üî¥</span></h2>
                    <div class="prize-cards">
                        <label>Cartas Pr√™mio: </label>
                        <input type="number" id="player2-prizes" min="0" max="6" value="6" 
                               onchange="updatePrizeCards('player2', this.value)">
                    </div>
                    
                    <!-- Banco do Jogador 2 -->
                    <div class="bench">
                        <h3>Banco</h3>
                        <div class="bench-slots" id="player2-bench-slots"></div>
                    </div>
                    
                    <!-- Pok√©mon Ativo do Jogador 2 Centralizado -->
                    <div class="active-pokemon-section">
                        <h3>Pok√©mon Ativo</h3>
                        <div class="active-pokemon-container">
                            <div class="pokemon-slot active" data-player="player2" data-position="active">
                                <div class="pokemon-card" id="player2-active"></div>
                            </div>
                            
                            <!-- Controles do Pok√©mon Ativo -->
                            <div class="active-controls">
                                <!-- Select de Status -->
                                <div class="status-select-group">
                                    <label>Status de Efeito:</label>
                                    <select id="player2-status-select" onchange="updateStatusFromSelect('player2', 'active', this.value)">
                                        <option value="">Nenhum</option>
                                        <option value="Envenenado">üü£ Envenenado</option>
                                        <option value="Paralisado">‚ö° Paralisado</option>
                                        <option value="Adormecido">üò¥ Adormecido</option>
                                        <option value="Queimado">üî• Queimado</option>
                                        <option value="Confuso">üåÄ Confuso</option>
                                    </select>
                                </div>
                                
                                <!-- Controles de Contadores de Dano -->
                                <div class="damage-counter-controls">
                                    <label>Contadores de Dano:</label>
                                    <div class="counter-group">
                                        <input type="number" id="player2-damage-counters" min="0" class="counter-input" 
                                               onchange="updateDamageCounters('player2', 'active', this.value)">
                                        <span class="counter-label">üí•</span>
                                    </div>
                                </div>
                                
                                <!-- Controles de Dano/Cura -->
                                <div class="damage-controls">
                                    <div class="control-group">
                                        <input type="number" id="player2-damage" placeholder="Dano" min="0" class="damage-input">
                                        <button onclick="quickDamage('player2', 'active', 'player1')" class="damage-btn">üí• Dano</button>
                                    </div>
                                    <div class="control-group">
                                        <input type="number" id="player2-heal" placeholder="Cura" min="0" class="heal-input">
                                        <button onclick="quickHeal('player2', 'active')" class="heal-btn">üíö Curar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Divisor -->
                <div class="divider"></div>

                <!-- Jogador 1 -->
                <div class="player-section player1">
                    <h2>üë§ <span id="player1-name">Jogador 1</span> <span id="player1-status" class="connection-indicator">üî¥</span></h2>
                    <div class="prize-cards">
                        <label>Cartas Pr√™mio: </label>
                        <input type="number" id="player1-prizes" min="0" max="6" value="6" 
                               onchange="updatePrizeCards('player1', this.value)">
                    </div>
                    
                    <!-- Pok√©mon Ativo do Jogador 1 Centralizado -->
                    <div class="active-pokemon-section">
                        <h3>Pok√©mon Ativo</h3>
                        <div class="active-pokemon-container">
                            <div class="pokemon-slot active" data-player="player1" data-position="active">
                                <div class="pokemon-card" id="player1-active"></div>
                            </div>
                            
                            <!-- Controles do Pok√©mon Ativo -->
                            <div class="active-controls">
                                <!-- Select de Status -->
                                <div class="status-select-group">
                                    <label>Status de Efeito:</label>
                                    <select id="player1-status-select" onchange="updateStatusFromSelect('player1', 'active', this.value)">
                                        <option value="">Nenhum</option>
                                        <option value="Envenenado">üü£ Envenenado</option>
                                        <option value="Paralisado">‚ö° Paralisado</option>
                                        <option value="Adormecido">üí§ Adormecido</option>
                                        <option value="Queimado">üî• Queimado</option>
                                        <option value="Confuso">üåÄ Confuso</option>
                                    </select>
                                </div>
                                
                                <!-- Controles de Contadores de Dano -->
                                <div class="damage-counter-controls">
                                    <label>Contadores de Dano:</label>
                                    <div class="counter-group">
                                        <input type="number" id="player1-damage-counters" min="0" class="counter-input" 
                                               onchange="updateDamageCounters('player1', 'active', this.value)">
                                        <span class="counter-label">üí•</span>
                                    </div>
                                </div>
                                
                                <!-- Controles de Dano/Cura -->
                                <div class="damage-controls">
                                    <div class="control-group">
                                        <input type="number" id="player1-damage" placeholder="Dano" min="0" class="damage-input">
                                        <button onclick="quickDamage('player1', 'active', 'player2')" class="damage-btn">üí• Dano</button>
                                    </div>
                                    <div class="control-group">
                                        <input type="number" id="player1-heal" placeholder="Cura" min="0" class="heal-input">
                                        <button onclick="quickHeal('player1', 'active')" class="heal-btn">üíö Curar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Banco do Jogador 1 -->
                    <div class="bench">
                        <h3>Banco</h3>
                        <div class="bench-slots" id="player1-bench-slots"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar Pok√©mon -->
    <div id="pokemon-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Editar Pok√©mon</h2>
            
            <div class="form-group">
                <label>HP M√°ximo:</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="number" id="pokemon-max-hp" min="0" placeholder="HP M√°ximo" style="flex: 1;">
                    <button onclick="incrementMaxHp()" class="quick-increment-btn" title="Aumenta 10 HP">+10</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>HP Atual:</label>
                <input type="number" id="pokemon-current-hp" min="0" placeholder="HP Atual">
            </div>
            
            <div class="form-group">
                <label>Contadores de Dano:</label>
                <input type="number" id="pokemon-damage-counters" min="0" placeholder="Contadores de Dano">
            </div>
            
            <div class="modal-buttons">
                <button onclick="savePokemon()" class="save-btn">üíæ Salvar</button>
                <button onclick="closeModal()" class="cancel-btn">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Evolu√ß√£o -->
    <div id="evolution-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEvolutionModal()">&times;</span>
            <h2>‚ö° Evoluir Pok√©mon</h2>
            <div style="margin: 20px 0; text-align: center;">
                <p style="font-size: 1.2em; color: #2c3e50; margin-bottom: 10px;">
                    <strong id="evolution-pokemon-name">Pok√©mon</strong> est√° evoluindo!
                </p>
                <p style="color: #7f8c8d; font-size: 0.9em;">
                    Digite o novo HP m√°ximo. O dano atual ser√° preservado.
                </p>
            </div>
            
            <div class="form-group">
                <label>Novo HP M√°ximo:</label>
                <input type="number" id="evolution-new-hp" min="1" placeholder="Ex: 150">
            </div>
            
            <div class="modal-buttons">
                <button onclick="saveEvolution()" class="save-btn">‚ö° Evoluir</button>
                <button onclick="closeEvolutionModal()" class="cancel-btn">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Knockout -->
    <div id="knockout-modal" class="modal">
        <div class="modal-content knockout-modal-content">
            <h2>üíÄ KNOCKOUT!</h2>
            <div id="knockout-message"></div>
            <div class="modal-buttons">
                <button onclick="closeKnockoutModal()" class="save-btn">‚úÖ OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Vit√≥ria -->
    <div id="victory-modal" class="modal">
        <div class="modal-content victory-modal-content">
            <h2>üèÜ VIT√ìRIA!</h2>
            <div id="victory-message"></div>
            <div class="victory-celebration">
                <div class="fireworks">üéÜ</div>
                <div class="trophy">üèÜ</div>
                <div class="fireworks">üéá</div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeVictoryModal()" class="save-btn">üéä Celebrar</button>
                <button onclick="resetGame(); closeVictoryModal();" class="cancel-btn">üîÑ Novo Jogo</button>
            </div>
        </div>
    </div>

    <!-- Audio element para sons de vit√≥ria -->
    <audio id="victory-audio" preload="none">
        Seu navegador n√£o suporta √°udio.
    </audio>

    <script>
        // Vari√°veis globais
        let socket;
        let currentPlayer = '';
        let currentPosition = '';
        let gameState = {};
        let roomId = '';
        let myPlayer = '';
        let myPlayerName = '';
        let evolutionData = null;

        // Carregar dados em cache
        function loadFromCache() {
            const cached = localStorage.getItem('pokemon-tcg-cache');
            if (cached) {
                const data = JSON.parse(cached);
                roomId = data.roomId || '';
                myPlayer = data.myPlayer || '';
                myPlayerName = data.myPlayerName || '';
                return true;
            }
            return false;
        }

        // Salvar dados em cache
        function saveToCache() {
            localStorage.setItem('pokemon-tcg-cache', JSON.stringify({
                roomId: roomId,
                myPlayer: myPlayer,
                myPlayerName: myPlayerName
            }));
        }

        // Limpar cache
        function clearCache() {
            localStorage.removeItem('pokemon-tcg-cache');
        }

        // Inicializar conex√£o
        function initializeConnection() {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus(true);
                
                // Tentar reconectar se h√° dados em cache
                if (loadFromCache() && roomId && myPlayerName) {
                    socket.emit('rejoin_game', {
                        room_id: roomId,
                        player_name: myPlayerName
                    });
                }
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });
            
            socket.on('player_assigned', (data) => {
                myPlayer = data.player;
                roomId = data.room_id;
                gameState = data.game_state;
                
                // Salvar em cache
                saveToCache();
                
                document.getElementById('room-display').textContent = roomId;
                document.getElementById('player-role').textContent = `Voc√™ √©: ${myPlayerName}`;
                
                showGameScreen();
                adjustBoardLayout();
                updateUI();
            });
            
            socket.on('game_state_update', (data) => {
                gameState = data;
                updateUI();
            });
            
            socket.on('knockouts_occurred', (data) => {
                showKnockoutModal(data.knockouts);
            });
            
            socket.on('game_ended', (data) => {
                showVictoryModal(data.winner);
            });
            
            socket.on('victory_sound', (data) => {
                if (data.sound_url) {
                    playVictoryAudio(data.sound_url);
                }
            });
        }

        // Fun√ß√µes de conex√£o
        function createNewGame() {
            const playerName = document.getElementById('player-name-create').value.trim();
            if (!playerName) {
                showNotification('Por favor, digite seu nome!', 'error');
                return;
            }
            
            myPlayerName = playerName;
            socket.emit('join_game', { player_name: playerName });
        }

        function joinExistingGame() {
            const playerName = document.getElementById('player-name-join').value.trim();
            const code = document.getElementById('room-code').value.trim();
            
            if (!playerName) {
                showNotification('Por favor, digite seu nome!', 'error');
                return;
            }
            
            if (!code) {
                showNotification('Por favor, digite o c√≥digo da sala!', 'error');
                return;
            }
            
            myPlayerName = playerName;
            socket.emit('join_game', { room_id: code, player_name: playerName });
        }

        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            if (connected) {
                indicator.textContent = 'üü¢ Conectado';
                indicator.style.color = '#28a745';
            } else {
                indicator.textContent = 'üî¥ Desconectado';
                indicator.style.color = '#dc3545';
            }
        }

        function generateBenchSlots(player) {
            const container = document.getElementById(`${player}-bench-slots`);
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'pokemon-slot bench-slot';
                slot.dataset.player = player;
                slot.dataset.position = i;
                slot.innerHTML = `
                    <div class="pokemon-card" id="${player}-bench-${i}"></div>
                    <button class="promote-btn" onclick="swapWithActive('${player}', ${i})" style="display: none;">
                        ‚¨ÜÔ∏è Trocar
                    </button>
                `;
                container.appendChild(slot);
            }
        }

        function getPlayerName(playerKey) {
            return gameState[playerKey].name || (playerKey === 'player1' ? 'Jogador 1' : 'Jogador 2');
        }

        function showGameScreen() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            generateBenchSlots('player1');
            generateBenchSlots('player2');
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomId).then(() => {
                showNotification('C√≥digo da sala copiado!', 'success');
            });
        }

        // Atualizar interface
        function updateUI() {
            if (!gameState) return;
            
            // Atualizar ambos jogadores
            ['player1', 'player2'].forEach(player => {
                const playerData = gameState[player];
                updatePlayerUI(player, playerData);
            });
            
            // Atualizar banco
            for (let i = 0; i < 5; i++) {
                updatePokemonCard(`player1-bench-${i}`, gameState.player1.bench[i]);
                updatePokemonCard(`player2-bench-${i}`, gameState.player2.bench[i]);
            }
            
            // Atualizar bot√µes de troca
            updateSwapButtons();
            
            // Verificar se o jogo terminou
            if (gameState.game_ended && gameState.winner) {
                showVictoryModal(gameState.winner);
            }
        }

        function updatePlayerUI(player, playerData) {
            if (playerData.name) {
                document.getElementById(`${player}-name`).textContent = playerData.name;
            }
            
            document.getElementById(`${player}-status`).textContent = playerData.connected ? 'üü¢' : 'üî¥';
            document.getElementById(`${player}-prizes`).value = playerData.prize_cards;
            
            updatePokemonCard(`${player}-active`, playerData.active);
            updateStatusSelect(player, playerData.active.status_effects);
            document.getElementById(`${player}-damage-counters`).value = playerData.active.damage_counters || 0;
        }

        // Ajustar layout do tabuleiro para colocar cartas do jogador sempre em baixo
        function adjustBoardLayout() {
            const gameBoard = document.querySelector('.game-board');
            const player1Section = document.querySelector('.player1');
            const player2Section = document.querySelector('.player2');
            const divider = document.querySelector('.divider');
            
            if (!gameBoard || !player1Section || !player2Section || !divider) return;
            
            // Se voc√™ √© o jogador 2, reordenar com CSS flex-order
            if (myPlayer === 'player2') {
                // Player 1 (oponente) fica em cima
                player1Section.style.order = '1';
                divider.style.order = '2';
                // Player 2 (voc√™) fica em baixo
                player2Section.style.order = '3';
            } else {
                // Ordem padr√£o
                player2Section.style.order = '1';
                divider.style.order = '2';
                player1Section.style.order = '3';
            }
        }

        // Verificar se √© minha vez de jogar
        function canControl(player) {
            return myPlayer === player;
        }

        // Fun√ß√µes do jogo (adaptadas para WebSocket)
        function updatePokemon(player, position, pokemonData) {
            if (!canControl(player)) return;
            
            socket.emit('update_pokemon', {
                room_id: roomId,
                player: player,
                position: position,
                pokemon: pokemonData
            });
        }

        function quickDamage(player, position, attackingPlayer) {
            const damageInput = document.getElementById(`${player}-damage`);
            const damage = parseInt(damageInput.value) || 0;
            if (damage <= 0) return;
            
            socket.emit('apply_damage', {
                room_id: roomId,
                player: player,
                position: position,
                damage: damage,
                attacking_player: attackingPlayer
            });
            
            damageInput.value = '';
        }

        function quickHeal(player, position) {
            if (!canControl(player)) return;
            
            const healInput = document.getElementById(`${player}-heal`);
            const heal = parseInt(healInput.value) || 0;
            if (heal <= 0) return;
            
            socket.emit('heal_pokemon', {
                room_id: roomId,
                player: player,
                position: position,
                heal: heal
            });
            
            healInput.value = '';
        }

        function updateDamageCounters(player, position, counters) {
            if (!canControl(player)) return;
            
            socket.emit('update_damage_counters', {
                room_id: roomId,
                player: player,
                position: position,
                counters: parseInt(counters) || 0
            });
        }

        function swapWithActive(player, benchIndex) {
            if (!canControl(player)) return;
            
            socket.emit('swap_pokemon', {
                room_id: roomId,
                player: player,
                bench_index: benchIndex
            });
        }

        function updateStatusFromSelect(player, position, status) {
            if (!canControl(player)) return;
            
            // Remover status existentes
            const currentPokemon = gameState[player].active;
            for (const existingStatus of currentPokemon.status_effects) {
                socket.emit('remove_status', {
                    room_id: roomId,
                    player: player,
                    position: position,
                    status: existingStatus
                });
            }
            
            // Adicionar novo status
            if (status) {
                socket.emit('add_status', {
                    room_id: roomId,
                    player: player,
                    position: position,
                    status: status
                });
            }
        }

        function updatePrizeCards(player, value) {
            if (!canControl(player)) return;
            
            socket.emit('update_prize_cards', {
                room_id: roomId,
                player: player,
                prize_cards: parseInt(value)
            });
        }

        function resetGame() {
            if (confirm('Tem certeza que deseja resetar o jogo?')) {
                socket.emit('reset_game', {
                    room_id: roomId
                });
            }
        }

        function returnToHome() {
            if (confirm('Tem certeza que deseja voltar √† tela inicial? Voc√™ sair√° da sala.')) {
                clearCache();
                socket.disconnect();
                location.reload();
            }
        }

        function openEvolutionModal(player, position) {
            if (!canControl(player)) return;
            
            const pokemon = position === 'active' ? gameState[player].active : gameState[player].bench[parseInt(position)];
            
            evolutionData = {
                player: player,
                position: position,
                previousDamage: pokemon.max_hp - pokemon.current_hp
            };
            
            document.getElementById('evolution-pokemon-name').textContent = pokemon.name || 'Pok√©mon';
            document.getElementById('evolution-new-hp').value = '';
            document.getElementById('evolution-modal').style.display = 'block';
        }

        function closeEvolutionModal() {
            document.getElementById('evolution-modal').style.display = 'none';
            evolutionData = null;
        }

        function saveEvolution() {
            if (!evolutionData) return;
            
            const newMaxHp = parseInt(document.getElementById('evolution-new-hp').value) || 0;
            if (newMaxHp <= 0) {
                showNotification('Por favor, digite um HP v√°lido!', 'error');
                return;
            }
            
            const newCurrentHp = Math.max(0, newMaxHp - evolutionData.previousDamage);
            
            const pokemon = evolutionData.position === 'active' ? 
                gameState[evolutionData.player].active : 
                gameState[evolutionData.player].bench[parseInt(evolutionData.position)];
            
            const pokemonData = {
                name: pokemon.name,
                max_hp: newMaxHp,
                current_hp: newCurrentHp,
                status_effects: pokemon.status_effects,
                damage_counters: Math.floor(evolutionData.previousDamage / 10)
            };
            
            updatePokemon(evolutionData.player, evolutionData.position, pokemonData);
            closeEvolutionModal();
            showNotification('Pok√©mon evoluiu com sucesso!', 'success');
        }

        // Fun√ß√µes auxiliares
        function updatePokemonCard(elementId, pokemon) {
            const element = document.getElementById(elementId);
            const slot = element.closest('.pokemon-slot');
            const player = slot ? slot.dataset.player : null;
            const position = slot ? slot.dataset.position : null;
            
            if (pokemon.name) {
                const canEvolve = player && canControl(player);
                const evolveButton = canEvolve ? 
                    `<button onclick="event.stopPropagation(); openEvolutionModal('${player}', '${position}')" class="pokemon-evolve-btn" title="Evoluir Pok√©mon">‚ö°</button>` : '';
                
                element.innerHTML = `
                    <div class="pokemon-info">
                        ${evolveButton}
                        <div class="pokemon-name">${pokemon.name}</div>
                        <div class="pokemon-hp">${pokemon.current_hp}/${pokemon.max_hp} HP</div>
                        ${pokemon.damage_counters > 0 ? `<div class="damage-counters">üí• ${pokemon.damage_counters}</div>` : ''}
                        ${pokemon.status_effects.length > 0 ? `<div class="pokemon-status">${pokemon.status_effects.join(', ')}</div>` : ''}
                    </div>
                `;
                element.classList.add('has-pokemon');
                element.classList.remove('knocked-out');
            } else {
                element.innerHTML = '<div class="empty-slot">Clique para adicionar</div>';
                element.classList.remove('has-pokemon', 'knocked-out');
            }
        }

        function updateStatusSelect(player, statusEffects) {
            const select = document.getElementById(`${player}-status-select`);
            if (statusEffects.length > 0) {
                select.value = statusEffects[0];
            } else {
                select.value = '';
            }
        }

        function updateSwapButtons() {
            ['player1', 'player2'].forEach(player => {
                for (let i = 0; i < 5; i++) {
                    const benchPokemon = gameState[player].bench[i];
                    const swapBtn = document.querySelector(`[data-player="${player}"][data-position="${i}"] .promote-btn`);
                    
                    // Mostrar bot√£o se houver Pok√©mon no banco e for meu jogador
                    if (benchPokemon.name && canControl(player)) {
                        swapBtn.style.display = 'block';
                    } else {
                        swapBtn.style.display = 'none';
                    }
                }
            });
        }

        function showKnockoutModal(knockouts) {
            if (knockouts.length === 0) return;
            
            let message = '';
            knockouts.forEach(knockout => {
                const ownerName = getPlayerName(knockout.owner);
                const defeaterName = getPlayerName(knockout.defeated_by);
                const position = knockout.position === 'active' ? 'Ativo' : 'Banco';
                
                message += `
                    <div class="knockout-info">
                        <div class="knockout-pokemon">
                            <strong>${knockout.pokemon_name}</strong> (${ownerName} - ${position})
                        </div>
                        <div class="knockout-details">
                            Foi nocauteado por <strong>${defeaterName}</strong>
                        </div>
                        <div class="prize-info">
                            üèÜ ${defeaterName} coletou 1 carta pr√™mio!
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('knockout-message').innerHTML = message;
            document.getElementById('knockout-modal').style.display = 'block';
        }

        function closeKnockoutModal() {
            document.getElementById('knockout-modal').style.display = 'none';
        }

        function showVictoryModal(winner) {
            const winnerName = getPlayerName(winner);
            const winnerColor = winner === 'player1' ? '#3498db' : '#e74c3c';
            
            document.getElementById('victory-message').innerHTML = `
                <div class="winner-announcement" style="color: ${winnerColor};">
                    <h3>${winnerName} √© o CAMPE√ÉO!</h3>
                    <p>Todas as cartas pr√™mio foram coletadas!</p>
                    <div class="victory-stats">
                        <div>üèÜ Vit√≥ria conquistada!</div>
                        <div>üéØ Jogo finalizado com sucesso!</div>
                    </div>
                </div>
            `;
            
            document.getElementById('victory-modal').style.display = 'block';
            
            // Solicitar som de vit√≥ria
            socket.emit('get_victory_sound');
            
            // Adicionar confetes animados
            createConfetti();
        }

        function closeVictoryModal() {
            document.getElementById('victory-modal').style.display = 'none';
            
            // Parar √°udio se estiver tocando
            const audio = document.getElementById('victory-audio');
            audio.pause();
            audio.currentTime = 0;
        }

        function playVictoryAudio(soundUrl) {
            const audio = document.getElementById('victory-audio');
            audio.src = soundUrl;
            audio.volume = 0.7;
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log('Erro ao reproduzir √°udio:', error);
                    showNotification('üîä Som de vit√≥ria n√£o p√¥de ser reproduzido automaticamente', 'info');
                });
            }
        }

        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            confettiContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
            `;
            
            document.body.appendChild(confettiContainer);
            
            // Criar m√∫ltiplos confetes
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: absolute;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        left: ${Math.random() * 100}%;
                        animation: confetti-fall 3s linear forwards;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    `;
                    
                    confettiContainer.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 3000);
                }, i * 100);
            }
            
            setTimeout(() => {
                if (confettiContainer.parentNode) {
                    confettiContainer.parentNode.removeChild(confettiContainer);
                }
            }, 8000);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            let backgroundColor = '#28a745';
            if (type === 'error') backgroundColor = '#dc3545';
            if (type === 'info') backgroundColor = '#17a2b8';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
                background: ${backgroundColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Fun√ß√µes do modal de edi√ß√£o
        function openPokemonModal(player, position) {
            if (!canControl(player)) {
                showNotification('Voc√™ s√≥ pode editar seus pr√≥prios Pok√©mon!', 'error');
                return;
            }
            
            currentPlayer = player;
            currentPosition = position;
            
            let pokemon;
            if (position === 'active') {
                pokemon = gameState[player].active;
            } else {
                pokemon = gameState[player].bench[parseInt(position)];
            }
            
            document.getElementById('pokemon-max-hp').value = pokemon.max_hp || '';
            document.getElementById('pokemon-current-hp').value = pokemon.current_hp || '';
            document.getElementById('pokemon-damage-counters').value = pokemon.damage_counters || 0;
            
            document.getElementById('pokemon-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('pokemon-modal').style.display = 'none';
        }

        function incrementMaxHp() {
            const input = document.getElementById('pokemon-max-hp');
            const currentValue = parseInt(input.value) || 0;
            input.value = currentValue + 10;
        }

        function savePokemon() {
            const maxHp = parseInt(document.getElementById('pokemon-max-hp').value) || 0;
            let currentHp = parseInt(document.getElementById('pokemon-current-hp').value) || 0;
            const damageCounters = parseInt(document.getElementById('pokemon-damage-counters').value) || 0;
            
            // Se HP atual n√£o foi preenchido, usar HP m√°ximo (primeira vez)
            if (currentHp === 0 && maxHp > 0) {
                currentHp = maxHp;
            }
            
            // Gerar nome gen√©rico baseado na posi√ß√£o
            let pokemonName = '';
            if (currentPosition === 'active') {
                pokemonName = 'Pok√©mon Ativo';
            } else {
                pokemonName = `Pok√©mon ${parseInt(currentPosition) + 1}`;
            }
            
            const pokemonData = {
                name: pokemonName,
                max_hp: maxHp,
                current_hp: currentHp,
                status_effects: [],
                damage_counters: damageCounters
            };
            
            updatePokemon(currentPlayer, currentPosition, pokemonData);
            closeModal();
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            initializeConnection();
            
            // Remover transforma√ß√£o para mai√∫scula do campo de c√≥digo da sala
            const roomCodeInput = document.getElementById('room-code');
            roomCodeInput.addEventListener('input', function(e) {
                // Manter o texto como digitado, sem transformar para mai√∫scula
                this.value = this.value.toUpperCase();
            });
            
            // Event listeners para edi√ß√£o de Pok√©mon
            document.addEventListener('click', (e) => {
                if (e.target.closest('.pokemon-card')) {
                    e.stopPropagation();
                    const slot = e.target.closest('.pokemon-slot');
                    const player = slot.dataset.player;
                    const position = slot.dataset.position;
                    openPokemonModal(player, position);
                }
            });
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('pokemon-modal');
                const knockoutModal = document.getElementById('knockout-modal');
                const evolutionModal = document.getElementById('evolution-modal');
                const victoryModal = document.getElementById('victory-modal');
                
                if (event.target === modal) closeModal();
                if (event.target === knockoutModal) closeKnockoutModal();
                if (event.target === evolutionModal) closeEvolutionModal();
                if (event.target === victoryModal) closeVictoryModal();
            });
            
            // Adicionar estilos de anima√ß√£o
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                @keyframes confetti-fall {
                    to {
                        transform: translateY(100vh) rotate(720deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
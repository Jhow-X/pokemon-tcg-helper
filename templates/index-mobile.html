<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PokÃ©mon TCG Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style-mobile.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Tela de ConexÃ£o -->
    <div id="connection-screen" class="connection-screen">
        <div class="connection-content">
            <div class="logo">
                <h1>ğŸ´ PokÃ©mon TCG</h1>
                <p>Battle Tracker</p>
            </div>
            
            <div class="connection-options">
                <div class="option-card">
                    <div class="option-icon">ğŸ®</div>
                    <h3>Criar Partida</h3>
                    <input type="text" id="player-name-create" placeholder="Seu nome" maxlength="20">
                    <button onclick="createNewGame()" class="btn-primary">Criar Jogo</button>
                </div>
                
                <div class="option-card">
                    <div class="option-icon">ğŸ”—</div>
                    <h3>Entrar na Partida</h3>
                    <input type="text" id="player-name-join" placeholder="Seu nome" maxlength="20">
                    <input type="text" id="room-code" placeholder="CÃ³digo da Sala" maxlength="8">
                    <button onclick="joinExistingGame()" class="btn-secondary">Entrar</button>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="status-indicator">ğŸ”´ Desconectado</div>
            </div>
        </div>
    </div>

    <!-- Tela do Jogo -->
    <div id="game-screen" class="game-screen" style="display: none;">
        <!-- Header Mobile -->
        <header class="mobile-header">
            <div class="header-top">
                <div class="room-info">
                    <span class="room-label">Sala:</span>
                    <span class="room-code" id="room-display">-</span>
                    <button onclick="copyRoomCode()" class="copy-btn">ğŸ“‹</button>
                </div>
                <div class="header-buttons">
                    <button onclick="resetGame()" class="header-btn">ğŸ”„</button>
                    <button onclick="returnToHome()" class="header-btn">ğŸ </button>
                </div>
            </div>
        </header>

        <!-- Ãrea do Jogo -->
        <div class="game-container">
            <!-- Oponente (Topo) -->
            <div class="player-zone opponent-zone">
                <div class="player-card">
                    <div class="player-header-compact">
                        <div class="player-name-status">
                            <h2 id="player2-name">Oponente</h2>
                            <span id="player2-status" class="status-indicator">ğŸ”´</span>
                        </div>
                        <div class="prize-display">
                            <span class="prize-label">ğŸ†</span>
                            <input type="number" id="player2-prizes" min="0" max="6" value="6" 
                                   onchange="updatePrizeCards('player2', this.value)" class="prize-input">
                        </div>
                    </div>

                    <!-- PokÃ©mon Ativo -->
                    <div class="active-pokemon-zone">
                        <div class="pokemon-card-large" id="player2-active" onclick="showPokemonModal('player2', 'active')"></div>
                    </div>

                    <!-- Controles do Ativo -->
                    <div class="controls-section" id="player2-controls">
                        <div class="control-row">
                            <select id="player2-status-select" onchange="updateStatusFromSelect('player2', 'active', this.value)" class="status-select">
                                <option value="">Status</option>
                                <option value="Envenenado">ğŸŸ£ Envenenado</option>
                                <option value="Paralisado">âš¡ Paralisado</option>
                                <option value="Adormecido">ğŸ˜´ Adormecido</option>
                                <option value="Queimado">ğŸ”¥ Queimado</option>
                                <option value="Confuso">ğŸŒ€ Confuso</option>
                            </select>
                            <div class="counter-input">
                                <input type="number" id="player2-damage-counters" min="0" placeholder="ğŸ’¥" 
                                       onchange="updateDamageCounters('player2', 'active', this.value)" class="counter-small">
                            </div>
                        </div>
                        <div class="control-row">
                            <input type="number" id="player2-damage" placeholder="Dano" min="0" class="damage-input">
                            <button onclick="quickDamage('player2', 'active', 'player1')" class="btn-damage">ğŸ’¥</button>
                        </div>
                        <div class="control-row">
                            <input type="number" id="player2-heal" placeholder="Cura" min="0" class="heal-input">
                            <button onclick="quickHeal('player2', 'active')" class="btn-heal">ğŸ’š</button>
                        </div>
                    </div>

                    <!-- Banco do Oponente (aparece atrÃ¡s) -->
                    <div class="bench-zone">
                        <div class="bench-grid" id="player2-bench-container"></div>
                    </div>
                </div>
            </div>

            <!-- Divisor -->
            <div class="game-divider"></div>

            <!-- Seu PokÃ©mon (Baixo) -->
            <div class="player-zone player-zone-self">
                <div class="player-card">
                    <!-- Banco do Jogador -->
                    <div class="bench-zone">
                        <div class="bench-grid" id="player1-bench-container"></div>
                    </div>

                    <!-- PokÃ©mon Ativo -->
                    <div class="active-pokemon-zone">
                        <div class="pokemon-card-large" id="player1-active" onclick="showPokemonModal('player1', 'active')"></div>
                    </div>

                    <!-- Controles do Ativo -->
                    <div class="controls-section" id="player1-controls">
                        <div class="control-row">
                            <select id="player1-status-select" onchange="updateStatusFromSelect('player1', 'active', this.value)" class="status-select">
                                <option value="">Status</option>
                                <option value="Envenenado">ğŸŸ£ Envenenado</option>
                                <option value="Paralisado">âš¡ Paralisado</option>
                                <option value="Adormecido">ğŸ˜´ Adormecido</option>
                                <option value="Queimado">ğŸ”¥ Queimado</option>
                                <option value="Confuso">ğŸŒ€ Confuso</option>
                            </select>
                            <div class="counter-input">
                                <input type="number" id="player1-damage-counters" min="0" placeholder="ğŸ’¥" 
                                       onchange="updateDamageCounters('player1', 'active', this.value)" class="counter-small">
                            </div>
                        </div>
                        <div class="control-row">
                            <input type="number" id="player1-damage" placeholder="Dano" min="0" class="damage-input">
                            <button onclick="quickDamage('player1', 'active', 'player2')" class="btn-damage">ğŸ’¥</button>
                        </div>
                        <div class="control-row">
                            <input type="number" id="player1-heal" placeholder="Cura" min="0" class="heal-input">
                            <button onclick="quickHeal('player1', 'active')" class="btn-heal">ğŸ’š</button>
                        </div>
                    </div>

                    <div class="player-header-compact">
                        <div class="player-name-status">
                            <h2 id="player1-name">VocÃª</h2>
                            <span id="player1-status" class="status-indicator">ğŸŸ¢</span>
                        </div>
                        <div class="prize-display">
                            <span class="prize-label">ğŸ†</span>
                            <input type="number" id="player1-prizes" min="0" max="6" value="6" 
                                   onchange="updatePrizeCards('player1', this.value)" class="prize-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar PokÃ©mon -->
    <div id="pokemon-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar PokÃ©mon</h3>
                <button onclick="closeModal()" class="modal-close">âœ•</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>HP MÃ¡ximo:</label>
                    <input type="number" id="pokemon-max-hp" min="0" placeholder="HP MÃ¡ximo">
                </div>
                
                <div class="form-group">
                    <label>HP Atual:</label>
                    <div class="hp-input-group">
                        <input type="number" id="pokemon-current-hp" min="0" placeholder="HP Atual">
                        <button onclick="addQuickHp()" class="quick-increment-btn">+10</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Contadores de Dano:</label>
                    <input type="number" id="pokemon-damage-counters" min="0" placeholder="Contadores">
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="savePokemon()" class="btn-primary">ğŸ’¾ Salvar</button>
                <button onclick="closeModal()" class="btn-secondary">âŒ Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de EvoluÃ§Ã£o -->
    <div id="evolution-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Evoluir PokÃ©mon</h3>
                <button onclick="closeEvolutionModal()" class="modal-close">âœ•</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>HP MÃ¡ximo:</label>
                    <input type="number" id="evolution-max-hp" min="0" placeholder="HP MÃ¡ximo">
                </div>
                
                <div class="form-group">
                    <label>Dano Preservado:</label>
                    <input type="number" id="evolution-damage" min="0" placeholder="Dano atual serÃ¡ preservado" readonly>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="saveEvolution()" class="btn-primary">âœ… Evoluir</button>
                <button onclick="closeEvolutionModal()" class="btn-secondary">âŒ Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Knockout -->
    <div id="knockout-modal" class="modal">
        <div class="modal-content knockout-modal">
            <div class="modal-header">
                <h3>ğŸ’€ KNOCKOUT!</h3>
                <button onclick="closeKnockoutModal()" class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="knockout-message"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeKnockoutModal()" class="btn-primary">âœ… OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de VitÃ³ria -->
    <div id="victory-modal" class="modal">
        <div class="modal-content victory-modal">
            <div class="modal-header">
                <h3>ğŸ† VITÃ“RIA!</h3>
            </div>
            <div class="modal-body">
                <div id="victory-message"></div>
                <div class="victory-celebration">ğŸ† ğŸ† ğŸ‡</div>
            </div>
            <div class="modal-footer">
                <button onclick="closeVictoryModal()" class="btn-primary">ğŸŠ OK</button>
            </div>
        </div>
    </div>

    <!-- Audio element -->
    <audio id="victory-audio" preload="none"></audio>

    <script>
        // VariÃ¡veis globais
        let socket;
        let currentPlayer = '';
        let currentPosition = '';
        let gameState = {};
        let roomId = '';
        let myPlayer = '';
        let myPlayerName = '';

        // Cache functions
        function loadFromCache() {
            const cached = localStorage.getItem('pokemonGameSession');
            return cached ? JSON.parse(cached) : null;
        }

        function saveToCache() {
            const sessionData = {
                roomId: roomId,
                myPlayer: myPlayer,
                myPlayerName: myPlayerName,
                gameState: gameState,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('pokemonGameSession', JSON.stringify(sessionData));
        }

        function clearCache() {
            localStorage.removeItem('pokemonGameSession');
        }

        // Inicializar conexÃ£o
        function initializeConnection() {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus(true);
                const cached = loadFromCache();
                if (cached && cached.roomId) {
                    myPlayer = cached.myPlayer;
                    myPlayerName = cached.myPlayerName;
                    roomId = cached.roomId;
                    socket.emit('rejoin_game', {
                        room_id: roomId,
                        player: myPlayer,
                        player_name: myPlayerName
                    });
                }
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });
            
            socket.on('player_assigned', (data) => {
                myPlayer = data.player;
                roomId = data.room_id;
                gameState = data.game_state;
                
                document.getElementById('room-display').textContent = roomId;
                
                showGameScreen();
                saveToCache();
                updateUI();
            });
            
            socket.on('game_state_update', (data) => {
                gameState = data;
                saveToCache();
                updateUI();
            });
            
            socket.on('knockouts_occurred', (data) => {
                showKnockoutModal(data.knockouts);
            });
            
            socket.on('game_ended', (data) => {
                showVictoryModal(data.winner);
            });
            
            socket.on('victory_sound', (data) => {
                if (data.sound_url) {
                    playVictoryAudio(data.sound_url);
                }
            });
        }

        // FunÃ§Ãµes de conexÃ£o
        function createNewGame() {
            const playerName = document.getElementById('player-name-create').value.trim();
            if (!playerName) {
                showNotification('Por favor, digite seu nome!', 'error');
                return;
            }
            
            myPlayerName = playerName;
            socket.emit('join_game', { player_name: playerName });
        }

        function joinExistingGame() {
            const playerName = document.getElementById('player-name-join').value.trim();
            const code = document.getElementById('room-code').value.trim();
            
            if (!playerName) {
                showNotification('Por favor, digite seu nome!', 'error');
                return;
            }
            
            if (!code) {
                showNotification('Por favor, digite o cÃ³digo da sala!', 'error');
                return;
            }
            
            myPlayerName = playerName;
            socket.emit('join_game', { room_id: code, player_name: playerName });
        }

        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            if (connected) {
                indicator.textContent = 'ğŸŸ¢ Conectado';
                indicator.style.color = '#28a745';
            } else {
                indicator.textContent = 'ğŸ”´ Desconectado';
                indicator.style.color = '#dc3545';
            }
        }

        function showGameScreen() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomId).then(() => {
                showNotification('CÃ³digo copiado!', 'success');
            });
        }

        // Helper functions
        function getPlayerName(player) {
            return gameState[player]?.name || (player === 'player1' ? 'Jogador 1' : 'Jogador 2');
        }

        function canControl(player) {
            return myPlayer === player;
        }

        function generateBenchSlots(player) {
            let html = '';
            for (let i = 0; i < 5; i++) {
                html += `
                    <div class="bench-slot" onclick="showPokemonModal('${player}', '${i}')">
                        <div class="pokemon-card-bench" id="${player}-bench-${i}"></div>
                        <button class="swap-btn" onclick="swapWithActive('${player}', ${i}); event.stopPropagation();">â†•ï¸</button>
                    </div>
                `;
            }
            return html;
        }

        function generateAndShowBench(player) {
            const container = document.getElementById(`${player}-bench-container`);
            container.innerHTML = generateBenchSlots(player);
            updateSwapButtons();
        }

        // Atualizar interface
        function updateUI() {
            if (!gameState) return;
            
            // Gerar bancos se nÃ£o existirem
            if (!document.getElementById('player1-bench-0')) {
                generateAndShowBench('player1');
                generateAndShowBench('player2');
            }
            
            // Atualizar nomes e status
            document.getElementById('player1-name').textContent = getPlayerName('player1');
            document.getElementById('player2-name').textContent = getPlayerName('player2');
            
            document.getElementById('player1-status').textContent = gameState.player1.connected ? 'ğŸŸ¢' : 'ğŸ”´';
            document.getElementById('player2-status').textContent = gameState.player2.connected ? 'ğŸŸ¢' : 'ğŸ”´';
            
            // Atualizar cartas prÃªmio
            document.getElementById('player1-prizes').value = gameState.player1.prize_cards;
            document.getElementById('player2-prizes').value = gameState.player2.prize_cards;
            
            // Atualizar PokÃ©mon ativos
            updatePokemonCard('player1-active', gameState.player1.active, 'player1', 'active');
            updatePokemonCard('player2-active', gameState.player2.active, 'player2', 'active');
            
            // Atualizar bancos
            for (let i = 0; i < 5; i++) {
                updatePokemonCard(`player1-bench-${i}`, gameState.player1.bench[i], 'player1', i);
                updatePokemonCard(`player2-bench-${i}`, gameState.player2.bench[i], 'player2', i);
            }
            
            // Atualizar selects de status
            if (gameState.player1.active?.status_effects?.length > 0) {
                document.getElementById('player1-status-select').value = gameState.player1.active.status_effects[0] || '';
            }
            if (gameState.player2.active?.status_effects?.length > 0) {
                document.getElementById('player2-status-select').value = gameState.player2.active.status_effects[0] || '';
            }
            
            // Atualizar contadores
            document.getElementById('player1-damage-counters').value = gameState.player1.active?.damage_counters || 0;
            document.getElementById('player2-damage-counters').value = gameState.player2.active?.damage_counters || 0;
            
            // Atualizar botÃµes de troca
            updateSwapButtons();
        }

        function updatePokemonCard(elementId, pokemon, player, position) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (pokemon && pokemon.name) {
                const damageDisplay = pokemon.damage_counters > 0 ? `ğŸ’¥${pokemon.damage_counters}` : '';
                const statusEmoji = pokemon.status_effects?.length > 0 ? 'âš ï¸' : '';
                const evolveBtn = player ? `<button class="evolve-btn" onclick="openEvolutionModal('${player}', '${position}'); event.stopPropagation();">â¬†ï¸</button>` : '';
                
                if (elementId.includes('active')) {
                    element.innerHTML = `
                        <div class="pokemon-large">
                            <div class="poke-name">${pokemon.name}</div>
                            <div class="poke-hp">${pokemon.current_hp}/${pokemon.max_hp}</div>
                            <div class="poke-extras">${damageDisplay} ${statusEmoji}</div>
                            ${evolveBtn}
                        </div>
                    `;
                } else {
                    element.innerHTML = `
                        <div class="pokemon-small">
                            <div class="poke-name-small">${pokemon.name}</div>
                            <div class="poke-hp-small">${pokemon.current_hp}/${pokemon.max_hp}</div>
                            ${damageDisplay ? `<div class="poke-dmg-small">${damageDisplay}</div>` : ''}
                            ${evolveBtn}
                        </div>
                    `;
                }
                element.classList.add('has-pokemon');
            } else {
                element.innerHTML = '<div class="empty-pokemon">+</div>';
                element.classList.remove('has-pokemon');
            }
        }

        function updateSwapButtons() {
            ['player1', 'player2'].forEach(player => {
                for (let i = 0; i < 5; i++) {
                    const benchPokemon = gameState[player]?.bench[i];
                    const swapBtn = document.querySelector(`#${player}-bench-${i}`)?.parentElement?.querySelector('.swap-btn');
                    
                    if (swapBtn && benchPokemon?.name && canControl(player)) {
                        swapBtn.style.display = 'block';
                    } else if (swapBtn) {
                        swapBtn.style.display = 'none';
                    }
                }
            });
        }

        // FunÃ§Ãµes de controle de jogo
        function updatePokemon(player, position, pokemonData) {
            if (!canControl(player)) return;
            
            socket.emit('update_pokemon', {
                room_id: roomId,
                player: player,
                position: position,
                pokemon: pokemonData
            });
        }

        function swapWithActive(player, benchIndex) {
            if (!canControl(player)) return;
            event.stopPropagation();
            
            socket.emit('swap_pokemon', {
                room_id: roomId,
                player: player,
                bench_index: benchIndex
            });
        }

        function updatePrizeCards(player, value) {
            if (!canControl(player)) return;
            
            socket.emit('update_prize_cards', {
                room_id: roomId,
                player: player,
                prize_cards: parseInt(value)
            });
        }

        function updateStatusFromSelect(player, position, status) {
            if (!canControl(player)) return;
            
            const currentPokemon = position === 'active' ? gameState[player].active : gameState[player].bench[parseInt(position)];
            for (const existingStatus of currentPokemon.status_effects) {
                socket.emit('remove_status', {
                    room_id: roomId,
                    player: player,
                    position: position,
                    status: existingStatus
                });
            }
            
            if (status) {
                socket.emit('add_status', {
                    room_id: roomId,
                    player: player,
                    position: position,
                    status: status
                });
            }
        }

        function updateDamageCounters(player, position, counters) {
            if (!canControl(player)) return;
            
            socket.emit('update_damage_counters', {
                room_id: roomId,
                player: player,
                position: position,
                counters: parseInt(counters) || 0
            });
        }

        function quickDamage(player, position, attackingPlayer) {
            if (!canControl(player)) return;
            
            const damageInput = document.getElementById(`${player}-damage`);
            const damage = parseInt(damageInput.value) || 0;
            if (damage <= 0) return;
            
            socket.emit('apply_damage', {
                room_id: roomId,
                player: player,
                position: position,
                damage: damage,
                attacking_player: attackingPlayer
            });
            
            damageInput.value = '';
        }

        function quickHeal(player, position) {
            if (!canControl(player)) return;
            
            const healInput = document.getElementById(`${player}-heal`);
            const heal = parseInt(healInput.value) || 0;
            if (heal <= 0) return;
            
            socket.emit('heal_pokemon', {
                room_id: roomId,
                player: player,
                position: position,
                heal: heal
            });
            
            healInput.value = '';
        }

        function resetGame() {
            if (confirm('Resetar o jogo?')) {
                socket.emit('reset_game', {
                    room_id: roomId
                });
            }
        }

        function returnToHome() {
            if (confirm('Voltar para a tela inicial?')) {
                clearCache();
                location.reload();
            }
        }

        // FunÃ§Ãµes de modal
        function showPokemonModal(player, position) {
            if (!canControl(player)) return;
            
            const pokemon = position === 'active' ? gameState[player].active : gameState[player].bench[parseInt(position)];
            
            if (!pokemon.name) {
                openPokemonModal(player, position);
                return;
            }
            
            currentPlayer = player;
            currentPosition = position;
            
            document.getElementById('pokemon-max-hp').value = pokemon.max_hp || '';
            document.getElementById('pokemon-current-hp').value = pokemon.current_hp || '';
            document.getElementById('pokemon-damage-counters').value = pokemon.damage_counters || 0;
            
            document.getElementById('pokemon-modal').style.display = 'flex';
        }

        function openPokemonModal(player, position) {
            if (!canControl(player)) {
                showNotification('VocÃª sÃ³ pode editar seus PokÃ©mon!', 'error');
                return;
            }
            
            currentPlayer = player;
            currentPosition = position;
            
            const pokemon = position === 'active' ? gameState[player].active : gameState[player].bench[parseInt(position)];
            
            document.getElementById('pokemon-max-hp').value = pokemon.max_hp || '';
            document.getElementById('pokemon-current-hp').value = pokemon.current_hp || '';
            document.getElementById('pokemon-damage-counters').value = pokemon.damage_counters || 0;
            
            document.getElementById('pokemon-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('pokemon-modal').style.display = 'none';
        }

        function addQuickHp() {
            const currentInput = document.getElementById('pokemon-current-hp');
            const currentValue = parseInt(currentInput.value) || 0;
            currentInput.value = currentValue + 10;
        }

        function savePokemon() {
            const maxHp = parseInt(document.getElementById('pokemon-max-hp').value) || 0;
            let currentHp = parseInt(document.getElementById('pokemon-current-hp').value) || 0;
            const damageCounters = parseInt(document.getElementById('pokemon-damage-counters').value) || 0;
            
            if (!document.getElementById('pokemon-current-hp').value && maxHp > 0) {
                currentHp = maxHp;
            }
            
            const pokemonData = {
                name: 'PokÃ©mon',
                max_hp: maxHp,
                current_hp: currentHp,
                status_effects: [],
                damage_counters: damageCounters
            };
            
            updatePokemon(currentPlayer, currentPosition, pokemonData);
            closeModal();
        }

        function openEvolutionModal(player, position) {
            if (!canControl(player)) return;
            
            currentPlayer = player;
            currentPosition = position;
            
            const pokemon = position === 'active' ? gameState[player].active : gameState[player].bench[parseInt(position)];
            
            document.getElementById('evolution-max-hp').value = pokemon.max_hp || '';
            document.getElementById('evolution-damage').value = pokemon.current_hp < pokemon.max_hp ? (pokemon.max_hp - pokemon.current_hp) : 0;
            
            document.getElementById('evolution-modal').style.display = 'flex';
        }

        function closeEvolutionModal() {
            document.getElementById('evolution-modal').style.display = 'none';
        }

        function saveEvolution() {
            const maxHp = parseInt(document.getElementById('evolution-max-hp').value) || 0;
            const damage = parseInt(document.getElementById('evolution-damage').value) || 0;
            
            const pokemon = currentPosition === 'active' ? gameState[currentPlayer].active : gameState[currentPlayer].bench[parseInt(currentPosition)];
            const newCurrentHp = Math.max(0, maxHp - damage);
            
            const evolvedData = {
                name: 'PokÃ©mon',
                max_hp: maxHp,
                current_hp: newCurrentHp,
                status_effects: pokemon.status_effects || [],
                damage_counters: pokemon.damage_counters || 0
            };
            
            updatePokemon(currentPlayer, currentPosition, evolvedData);
            closeEvolutionModal();
        }

        // FunÃ§Ãµes de notificaÃ§Ã£o
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                padding: 12px 20px; border-radius: 25px; color: white; font-weight: bold;
                z-index: 2000; font-size: 14px; text-align: center;
                background: ${type === 'error' ? '#e74c3c' : '#28a745'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // FunÃ§Ãµes de knockout e vitÃ³ria
        function showKnockoutModal(knockouts) {
            if (knockouts.length === 0) return;
            
            let message = '';
            knockouts.forEach(knockout => {
                const ownerName = knockout.owner === 'player1' ? getPlayerName('player1') : getPlayerName('player2');
                const defeaterName = knockout.defeated_by === 'player1' ? getPlayerName('player1') : getPlayerName('player2');
                
                message += `<div class="knockout-item">${knockout.pokemon_name}: ${ownerName} â†’ ${defeaterName} ğŸ†</div>`;
            });
            
            document.getElementById('knockout-message').innerHTML = message;
            document.getElementById('knockout-modal').style.display = 'flex';
        }

        function closeKnockoutModal() {
            document.getElementById('knockout-modal').style.display = 'none';
        }

        function showVictoryModal(winner) {
            const winnerName = winner === 'player1' ? getPlayerName('player1') : getPlayerName('player2');
            
            document.getElementById('victory-message').innerHTML = `<strong>${winnerName}</strong> VENCEU!`;
            document.getElementById('victory-modal').style.display = 'flex';
            
            socket.emit('get_victory_sound');
        }

        function closeVictoryModal() {
            document.getElementById('victory-modal').style.display = 'none';
            
            const audio = document.getElementById('victory-audio');
            audio.pause();
            audio.currentTime = 0;
        }

        function playVictoryAudio(soundUrl) {
            const audio = document.getElementById('victory-audio');
            audio.src = soundUrl;
            audio.volume = 0.7;
            audio.play().catch(() => {});
        }

        // InicializaÃ§Ã£o
        document.addEventListener('DOMContentLoaded', () => {
            initializeConnection();
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
